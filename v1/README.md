# Автоматическое Создание SOCKS5 Прокси с Использованием `autossh`

Этот Python-скрипт предназначен для автоматического создания и управления SOCKS5 прокси-сервером с использованием `autossh`. Скрипт обеспечивает надежное SSH-туннелирование, автоматическое восстановление соединения при разрыве и подробное логирование событий.

## Содержание

- [Описание](#описание)
- [Возможности](#возможности)
- [Требования](#требования)
- [Установка](#установка)
- [Настройка](#настройка)
- [Использование](#использование)
- [Структура Кода](#структура-кода)
  - [Функции](#функции)
- [Логирование](#логирование)
- [Обработка Сигналов](#обработка-сигналов)
- [Обработка Ошибок](#обработка-ошибок)
- [Лицензия](#лицензия)

## Описание

Скрипт создает SOCKS5 прокси-сервер на локальном компьютере, перенаправляя трафик через удаленный SSH-сервер. Это позволяет безопасно обходить ограничения сети, обеспечивать анонимность и защищать данные.

## Возможности

- Автоматическое создание SSH-туннеля с использованием `autossh`.
- Поддержка различных алгоритмов шифрования и аутентификации.
- Подробное логирование событий в файл и консоль с цветовой разметкой.
- Автоматическое восстановление соединения при его разрыве.
- Обработка системных сигналов для корректного завершения работы.

## Требования

- Python 3.x
- Установленные утилиты:
  - `autossh`
  - `sshpass`
- Библиотеки Python:
  - `colorama`

## Установка

1. **Установка необходимых утилит:**

   ```bash
   sudo apt update
   sudo apt install autossh sshpass
   ```

2. **Установка Python-зависимостей:**

   ```bash
   pip install colorama
   ```

3. **Скачивание скрипта:**

   Сохраните предоставленный скрипт в файл, например, `autossh_tunnel.py`.

## Настройка

Перед запуском скрипта необходимо настроить параметры подключения. Откройте скрипт и отредактируйте следующие переменные:

- `REMOTE_HOST`: IP-адрес или доменное имя удаленного SSH-сервера.
- `REMOTE_PORT`: Порт SSH-сервера (по умолчанию 22).
- `SSH_USER`: Имя пользователя для SSH-подключения.
- `SSH_PASSWORD`: Пароль пользователя для SSH-подключения.
- `LOCAL_PORT`: Локальный порт для SOCKS5 прокси (по умолчанию 6060).
- `LOG_FILE`: Путь к файлу логов (по умолчанию `/var/log/autossh_tunnel.log`).
- Другие параметры, такие как алгоритмы шифрования, сжатия и т.д., можно настроить по необходимости.

## Использование

Запустите скрипт командой:

```bash
python3 autossh_tunnel.py
```

Скрипт начнет установку SOCKS5 прокси на указанном локальном порту и подключится к удаленному SSH-серверу. Логи будут записываться как в файл, так и выводиться в консоль.

Для остановки скрипта используйте сочетание клавиш `Ctrl+C` или отправьте сигнал завершения процесса.

## Структура Кода

Скрипт состоит из нескольких функций, каждая из которых отвечает за определенный аспект работы:

### Функции

#### `setup_logging()`

Настраивает логирование событий как в файл, так и в консоль. Проверяет доступность файла логов для записи. Если нет прав на запись в файл, логирование происходит только в консоль с соответствующим предупреждением.

#### `log(message, level='INFO')`

Логирует сообщение с указанным уровнем важности (`INFO`, `WARNING`, `ERROR`, `DEBUG`) и добавляет цветовую разметку в консольный вывод для лучшей читаемости.

#### `check_command(command)`

Проверяет наличие указанной команды в системе. Если команда отсутствует, выводит сообщение об ошибке и предлагает установить ее с помощью `sudo apt install`.

#### `configure_connection()`

Выводит текущую конфигурацию подключения, включая хост, порт, пользователя, локальный порт SOCKS5, параметры сжатия, алгоритмы шифрования, MAC-алгоритмы, алгоритмы KEX и время ожидания подключения.

#### `kill_process()`

Завершает процесс `autossh`, если он запущен. Используется для корректного завершения работы скрипта и освобождения ресурсов.

#### `start_autossh()`

Запускает `autossh` для установления SOCKS5 прокси-туннеля с использованием настроек из конфигурации. Обрабатывает вывод процесса на предмет ошибок и автоматически завершает работу при разрыве соединения.

#### `signal_handler(signum, frame)`

Обработчик системных сигналов (`SIGINT`, `SIGTERM`) для корректного завершения работы скрипта. Вызывает `kill_process()` и завершает выполнение программы.

#### `main()`

Главная функция запуска скрипта. Выполняет следующие шаги:

1. Настраивает логирование.
2. Проверяет наличие необходимых утилит (`autossh`, `sshpass`).
3. Выводит конфигурацию подключения.
4. Настраивает обработку системных сигналов.
5. Запускает `autossh` для установления прокси-соединения.
6. Обрабатывает исключения и гарантирует завершение процесса `autossh` при ошибках или прерывании.

## Логирование

Логи записываются как в указанный файл (`LOG_FILE`), так и выводятся в консоль. При недостаточных правах на запись в файл, логирование происходит только в консоль с соответствующим предупреждением. Логирование включает временные метки, уровень важности и цветовую разметку для удобства чтения.

## Обработка Сигналов

Скрипт обрабатывает системные сигналы `SIGINT` и `SIGTERM`, что позволяет корректно завершать работу при получении соответствующих сигналов (например, при нажатии `Ctrl+C` или при завершении процесса системой). При получении сигнала вызывается функция `signal_handler`, которая завершает процесс `autossh` и выходит из программы.

## Обработка Ошибок

Скрипт включает обширную обработку ошибок, включая:

- Проверку наличия необходимых утилит.
- Обработку исключений при запуске `autossh`.
- Обработку ошибок прав доступа при записи в файл логов.
- Вывод подробной информации об ошибках для облегчения отладки.

При возникновении необработанных ошибок скрипт завершает работу и выводит соответствующие сообщения в лог.

## Лицензия

Этот проект распространяется под лицензией [MIT License](LICENSE).

---

*Разработано с ❤️ с использованием Python и `autossh`.*

